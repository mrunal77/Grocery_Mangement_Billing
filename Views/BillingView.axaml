<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:GroceryStore.ViewModels"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="1000" d:DesignHeight="700"
             x:Class="GroceryStore.Views.BillingView"
             x:DataType="vm:BillingViewModel">

    <Grid ColumnDefinitions="*,400">
        <!-- Products Panel -->
        <Grid Grid.Column="0" RowDefinitions="Auto,*">
            <Border Grid.Column="0" Background="White" Margin="32,32,16,0" CornerRadius="12" Padding="4" BoxShadow="0 2 8 0 #10000000">
                <Grid ColumnDefinitions="Auto,*">
                    <PathIcon Grid.Column="0" Data="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" Foreground="#757575" Width="22" Height="22" VerticalAlignment="Center" Margin="16,0,12,0"/>
                    <TextBox Grid.Column="1" Text="{Binding SearchText}" Watermark="Search products by name or barcode..." Background="Transparent" BorderThickness="0" VerticalAlignment="Center" FontSize="15"/>
                </Grid>
            </Border>

            <Border Grid.Row="1" Background="White" Margin="32,16,16,32" CornerRadius="12" Padding="20" BoxShadow="0 2 8 0 #10000000">
                <DockPanel>
                    <TextBlock DockPanel.Dock="Top" Text="Available Products" FontSize="18" FontWeight="SemiBold" Margin="0,0,0,16"/>
                    
                    <ScrollViewer>
                        <ItemsControl ItemsSource="{Binding AvailableProducts}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Button Background="#F5F5F5" BorderBrush="#E0E0E0" BorderThickness="1" 
                                            Padding="16" Margin="6" MinWidth="160" MinHeight="100"
                                            CornerRadius="12"
                                            Command="{Binding $parent[ItemsControl].((vm:BillingViewModel)DataContext).AddToCartCommand}"
                                            CommandParameter="{Binding}">
                                        <StackPanel Spacing="6">
                                            <Border Background="#E8F5E9" CornerRadius="8" Padding="10" HorizontalAlignment="Left">
                                                <PathIcon Data="M20 2H4c-1 0-2 1-2 2v3.01c0 .72.43 1.34 1 1.69V20c0 1.1 1.1 2 2 2h14c.9 0 2-.9 2-2V8.7c.57-.35 1-.97 1-1.69V4c0-1-1-2-2-2zm-5 12H9v-2h6v2zm5-7H4V4l16-.02V7z" Foreground="#2E7D32" Width="20" Height="20"/>
                                            </Border>
                                            <TextBlock Text="{Binding Name}" FontWeight="Medium" TextTrimming="CharacterEllipsis" MaxWidth="140"/>
                                            <TextBlock Text="{Binding Price, StringFormat='${0:F2}'}" FontSize="16" FontWeight="Bold" Foreground="#2E7D32"/>
                                            <TextBlock Text="{Binding Quantity, StringFormat='Stock: {0}'}" FontSize="11" Foreground="#9E9E9E"/>
                                        </StackPanel>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </DockPanel>
            </Border>
        </Grid>

        <!-- Cart Panel -->
        <Border Grid.Column="1" Background="White" Margin="16,32,32,32" CornerRadius="16" Padding="24" BoxShadow="0 4 16 0 #15000000">
            <DockPanel>
                <StackPanel DockPanel.Dock="Top" Spacing="16" Margin="0,0,0,16">
                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <Border Background="#FFF3E0" CornerRadius="12" Padding="14">
                            <PathIcon Data="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14h-2V9h2v8zm-2-10V5h2v2h-2z" Foreground="#FF6F00" Width="26" Height="26"/>
                        </Border>
                        <TextBlock Text="Shopping Cart" FontSize="22" FontWeight="SemiBold" VerticalAlignment="Center"/>
                    </StackPanel>
                </StackPanel>

                <ScrollViewer DockPanel.Dock="Top" MaxHeight="350">
                    <ItemsControl ItemsSource="{Binding CartItems}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="#F5F5F5" CornerRadius="12" Padding="16" Margin="0,0,0,12">
                                    <Grid ColumnDefinitions="*,Auto">
                                        <StackPanel Grid.Column="0">
                                            <TextBlock Text="{Binding ProductName}" FontWeight="Medium" FontSize="15"/>
                                            <TextBlock Text="{Binding UnitPrice, StringFormat='${0:F2} each'}" FontSize="12" Foreground="#757575"/>
                                        </StackPanel>
                                        <StackPanel Grid.Column="1" HorizontalAlignment="Right">
                                            <StackPanel Orientation="Horizontal" Spacing="10" HorizontalAlignment="Center">
                                                <Button Content="-" Padding="12,5" Command="{Binding $parent[ItemsControl].((vm:BillingViewModel)DataContext).DecreaseQuantityCommand}" CommandParameter="{Binding}" Background="#E0E0E0"/>
                                                <TextBlock Text="{Binding Quantity}" VerticalAlignment="Center" MinWidth="30" TextAlignment="Center" FontWeight="Medium"/>
                                                <Button Content="+" Padding="12,5" Command="{Binding $parent[ItemsControl].((vm:BillingViewModel)DataContext).IncreaseQuantityCommand}" CommandParameter="{Binding}" Background="#E8F5E9" Foreground="#2E7D32"/>
                                            </StackPanel>
                                            <TextBlock Text="{Binding TotalPrice, StringFormat='${0:F2}'}" FontWeight="Bold" FontSize="16" Foreground="#2E7D32" HorizontalAlignment="Right" Margin="0,8,0,0"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <StackPanel DockPanel.Dock="Bottom" Spacing="12" Margin="0,16,0,0">
                    <Border Background="#FAFAFA" CornerRadius="12" Padding="16">
                        <StackPanel Spacing="8">
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBlock Grid.Column="0" Text="Subtotal" Foreground="#757575"/>
                                <TextBlock Grid.Column="1" Text="{Binding SubTotal, StringFormat='${0:F2}'}"/>
                            </Grid>
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBlock Grid.Column="0" Text="Tax (5%)" Foreground="#757575"/>
                                <TextBlock Grid.Column="1" Text="{Binding TaxAmount, StringFormat='${0:F2}'}"/>
                            </Grid>
                            <Border BorderBrush="#E0E0E0" BorderThickness="0,1,0,0" Margin="0,8,0,0" Padding="0,8,0,0">
                                <Grid ColumnDefinitions="*,Auto">
                                    <TextBlock Grid.Column="0" Text="Total" FontWeight="Bold" FontSize="18"/>
                                    <TextBlock Grid.Column="1" Text="{Binding GrandTotal, StringFormat='${0:F2}'}" FontWeight="Bold" FontSize="20" Foreground="#2E7D32"/>
                                </Grid>
                            </Border>
                        </StackPanel>
                    </Border>
                    
                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto">
                        <Button Grid.Column="0" Content="Clear" Command="{Binding ClearCartCommand}" Classes="secondary" HorizontalAlignment="Stretch" Margin="0,0,6,0"/>
                        <Button Grid.Column="1" Content="Complete Sale" Command="{Binding CompleteSaleCommand}" Classes="accent" HorizontalAlignment="Stretch" Margin="6,0,0,0"/>
                    </Grid>
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- Receipt Dialog -->
        <Border IsVisible="{Binding ShowReceipt}" Grid.ColumnSpan="2" Background="#80000000">
            <Border Background="White" CornerRadius="20" Padding="40" MaxWidth="420" HorizontalAlignment="Center" VerticalAlignment="Center" BoxShadow="0 12 48 0 #60000000">
                <StackPanel Spacing="24">
                    <StackPanel HorizontalAlignment="Center" Spacing="12">
                        <Border Background="#E8F5E9" CornerRadius="50" Padding="24" HorizontalAlignment="Center">
                            <PathIcon Data="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" Foreground="#2E7D32" Width="48" Height="48"/>
                        </Border>
                        <TextBlock Text="Sale Complete!" FontSize="26" FontWeight="Bold" Foreground="#2E7D32" HorizontalAlignment="Center"/>
                        <TextBlock Text="Thank you for your purchase" FontSize="14" Foreground="#757575" HorizontalAlignment="Center"/>
                    </StackPanel>
                    
                    <Border Background="#F5F5F5" CornerRadius="12" Padding="20">
                        <StackPanel>
                            <TextBlock Text="Receipt" FontWeight="SemiBold" FontSize="16" Margin="0,0,0,12"/>
                            <ItemsControl ItemsSource="{Binding LastTransaction.Items}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid ColumnDefinitions="*,Auto" Margin="0,0,0,4">
                                            <TextBlock Grid.Column="0" Text="{Binding ProductName}" Foreground="#616161"/>
                                            <TextBlock Grid.Column="1" Text="{Binding TotalPrice, StringFormat='${0:F2}'}" Foreground="#616161"/>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                            <Border BorderBrush="#E0E0E0" BorderThickness="0,1,0,0" Margin="0,12,0,12" Padding="0,12,0,0">
                                <Grid ColumnDefinitions="*,Auto">
                                    <TextBlock Grid.Column="0" Text="Total Paid" FontWeight="Bold" FontSize="18"/>
                                    <TextBlock Grid.Column="1" Text="{Binding LastTransaction.TotalAmount, StringFormat='${0:F2}'}" FontWeight="Bold" FontSize="20" Foreground="#2E7D32"/>
                                </Grid>
                            </Border>
                        </StackPanel>
                    </Border>
                    
                    <Button Content="Close" Command="{Binding CloseReceiptCommand}" Classes="primary" HorizontalAlignment="Stretch" Padding="24,14"/>
                </StackPanel>
            </Border>
        </Border>
    </Grid>
</UserControl>
